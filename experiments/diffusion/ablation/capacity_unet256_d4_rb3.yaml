experiment:
  name: diffusion_ablation_capacity_unet256_d4_rb3
  phase: diffusion_ablation
  save_path: /work3/s233249/ImgiNav/experiments/diffusion/ablation/capacity_unet256_d4_rb3
  epochs_target: 1000
dataset:
  manifest: /work3/s233249/ImgiNav/datasets/augmented/manifest.csv  # Augmented dataset manifest with original + augmented images and latents
  outputs:
    latent: latent_path  # Use pre-embedded latents for faster training
  filters:
    is_empty:
    - false
    is_augmented: false  # Only use real (non-augmented) samples
  return_path: false
autoencoder:
  checkpoint: /work3/s233249/ImgiNav/experiments/phase1/phase1_6_AE_normalized/phase1_6_AE_normalized_checkpoint_best.pt
  frozen: true
unet:
  in_channels: 16
  out_channels: 16
  base_channels: 256
  depth: 4
  num_res_blocks: 3  # Increased from 2 for more capacity per level
  time_dim: 256  # Increased from 128 for richer time embeddings
  cond_channels: 0
  fusion_mode: none
  norm_groups: 8
  dropout: 0.2  # Increased from 0.1 to prevent memorization with predictable augmentations
scheduler:
  type: CosineScheduler
  num_steps: 500  # Keeping at 500 (similar quality to 1000 but faster)
training:
  seed: 42
  train_split: 0.8
  split_seed: 42
  batch_size: 32  # Increased for gradient stability (larger UNet, so moderate increase)
  num_workers: 8
  shuffle: true
  epochs: 500
  learning_rate: 0.0001  # Reduced for large model stability (256 base_channels needs lower LR)
  optimizer: AdamW
  weight_decay: 0.1  # Increased from 0.05 for stronger regularization to prevent memorization
  save_interval: 99999
  
  eval_interval: 5
  sample_interval: 10
  memorization_check_interval: 10  # Check every 5 epochs
  memorization_num_generate: 100
  memorization_num_training: 1000
  use_amp: true
  
  # Weighted sampling to balance distribution
  use_weighted_sampling: true
  column: class_combination  # Column to use for weighting (e.g., "class_combination", "content_category", "room_id")
  weighting_method: inverse_frequency  # Weighting method: "inverse_frequency", "sqrt", "log", "balanced"
  rare_threshold_percentile: 10.0  # Percentile below which classes are considered rare
  min_samples_threshold: 5  # Minimum samples for a class to be included (lower for combinations)
  max_weight: 20  # Cap weights to prevent over-sampling extremely rare classes (prevents memorization)
  use_grouped_weights: false  # Use grouped weights from stats file
  group_rare_classes: false  # Group rare classes into single category
  
  # Gradient clipping for stability (prevents gradient explosion in large models)
  max_grad_norm: 0.1  # Very aggressive clipping for 256 base_channels model to prevent gradient explosion
  
  scheduler:
    type: cosine
  loss:
    type: MSELoss
    key: pred_noise
    target: noise
    weight: 1.0

