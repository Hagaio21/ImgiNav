# Stage 3: Adversarial fine-tuning for stage2_unet128_d4
# Loads Stage 2 checkpoint and fine-tunes with discriminator

experiment:
  name: "diffusion_stage3_unet128_d4"
  phase: "diffusion_stage3"
  save_path: "/work3/s233249/ImgiNav/experiments/diffusion/stage3/stage3_unet128_d4"

# Load Stage 2 checkpoint
diffusion:
  stage2_checkpoint: /work3/s233249/ImgiNav/experiments/diffusion/stage2/stage2_unet128_d4/diffusion_stage2_unet128_d4_checkpoint_best.pt

# Autoencoder config (decoder stays frozen - only UNet is trained)
autoencoder:
  checkpoint: /work3/s233249/ImgiNav/experiments/phase1/phase1_6_AE_normalized/phase1_6_AE_normalized_checkpoint_best.pt
  frozen: true  # Keep decoder frozen - semantic and discriminator losses guide UNet only

# Discriminator (required)
discriminator:
  checkpoint: /path/to/discriminator_best.pt  # Update after training discriminator
  weight: 0.1

dataset:
  manifest: "/work3/s233249/ImgiNav/datasets/augmented/manifest.csv"
  outputs:
    latent: "latent_path"
    rgb: "layout_path"
    segmentation: "layout_path"
  filters:
    is_empty: [false]
  return_path: false

unet:
  in_channels: 16
  out_channels: 16
  base_channels: 128
  depth: 4
  num_res_blocks: 2
  time_dim: 128
  cond_channels: 0
  fusion_mode: "none"
  norm_groups: 8
  dropout: 0.2

scheduler:
  type: "CosineScheduler"
  num_steps: 500

training:
  seed: 42
  train_split: 0.8
  split_seed: 42
  batch_size: 64
  num_workers: 8
  shuffle: true
  epochs: 50
  learning_rate: 0.00003
  optimizer: AdamW
  weight_decay: 0.1
  save_interval: 99999
  eval_interval: 5
  sample_interval: 10
  use_amp: true
  max_grad_norm: 0.5
  
  loss:
    type: CompositeLoss
    losses:
      - type: MSELoss
        key: "pred_noise"
        target: "noise"
        weight: 1.0
      - type: SemanticLoss
        segmentation_loss:
          type: CrossEntropyLoss
          key: "segmentation"
          target: "segmentation"
          weight: 0.1
        perceptual_loss:
          type: PerceptualLoss
          key: "rgb"
          target: "rgb"
          weight: 0.05
      - type: DiscriminatorLoss
        key: "latent"
        weight: 0.1

